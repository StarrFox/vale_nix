{ lib, pkgs, ... }:
  let
    inherit (lib) makeBinPath;

    yubikeyIdentity = ./identities/yubikey-identity.txt;

  in {
    # Rage CLI for encrypting secrets.
    environment.systemPackages = with pkgs; [
      rage
      age-plugin-yubikey
    ];

    # Make `agenix` use the `rage` CLI by default.
    age.ageBin = "PATH=${makeBinPath [pkgs.age-plugin-yubikey]}:$PATH ${pkgs.rage}/bin/rage";

    # Instruct age to use the identity file for the YubiKey
    # which was generated by `age-plugin-yubikey` and also
    # set it as the master identity for rekeying.
    age.identityPaths = [yubikeyIdentity];
    rekey.masterIdentities = [yubikeyIdentity];

    age.secrets.sext_ovpn.file = ./sext.ovpn.age;
    age.secrets.vale_password.file = ./vale-password.age;
  }
